import cv2
import numpy as np
from sklearn.cluster import KMeans
from google.colab import files
from google.colab.patches import cv2_imshow
import matplotlib.pyplot as plt

def posterize_image(image_bytes, num_colors=8):
    try:
        nparr = np.frombuffer(image_bytes, np.uint8)
        original_img = cv2.imdecode(nparr, cv2.IMREAD_COLOR)
        original_img_rgb = cv2.cvtColor(original_img, cv2.COLOR_BGR2RGB)
    except Exception as e:
        print(f"Error reading image: {e}")
        return None, None

    pixels = original_img_rgb.reshape((-1, 3))
    pixels = np.float32(pixels)

    kmeans = KMeans(n_clusters=num_colors, n_init='auto', random_state=42)
    kmeans.fit(pixels)

    new_palette = np.uint8(kmeans.cluster_centers_)
    labels = kmeans.labels_

    posterized_img_data = new_palette[labels.flatten()]
    posterized_img = posterized_img_data.reshape(original_img_rgb.shape)
    
    return original_img_rgb, posterized_img

print("Please upload an image file (e.g., .jpg, .png).")
uploaded = files.upload()

if not uploaded:
    print("\nNo file was uploaded. Please run the cell again.")
else:
    filename = next(iter(uploaded))
    image_bytes = uploaded[filename]
    
    try:
        k = int(input("Enter the number of colors for the poster (e.g., 8): "))
    except ValueError:
        print("Invalid input. Using default of 8 colors.")
        k = 8

    original, posterized = posterize_image(image_bytes, num_colors=k)
    
    if original is not None and posterized is not None:
        plt.figure(figsize=(12, 6))
        
        plt.subplot(1, 2, 1)
        plt.imshow(original)
        plt.title('Original Image')
        plt.axis('off')
        
        plt.subplot(1, 2, 2)
        plt.imshow(posterized)
        plt.title(f'Posterized ({k} Colors)')
        plt.axis('off')
        
        plt.show()

        output_filename = f"posterized_{k}_colors_{filename}"
        
        posterized_bgr = cv2.cvtColor(posterized, cv2.COLOR_RGB2BGR)
        cv2.imwrite(output_filename, posterized_bgr)
        
        print(f"\nâœ… Successfully created posterized image!")
        print(f"Downloading the result as '{output_filename}'...")
        files.download(output_filename)
